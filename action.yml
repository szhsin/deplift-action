name: "Dependency Update (Deplift)"
description: "Updates dependencies using deplift, runs tests & build, and creates a PR."
author: "szhsin"

inputs:
  node-version:
    description: "Node.js version to use"
    required: true
    default: "24"
  branch:
    description: "Branch name for the PR"
    required: true
    default: "chore/deplift"
  pr-title:
    description: "Pull request title"
    required: true
    default: "chore(deps): update all dependencies to latest versions"
  pr-body:
    description: "Pull request body"
    required: true
    default: |
      Automated dependency update generated by GitHub Actions.

      This workflow:
      - Updated dependencies using [deplift](https://github.com/szhsin/deplift)
      - Ran tests
      - Ran the build and committed any generated changes
  labels:
    description: "Labels for the PR"
    required: false
    default: "dependencies, automated"
  committer:
    description: "Committer name and email"
    required: false
    default: "Zheng Song <41896553+szhsin@users.noreply.github.com>"
  commit-message:
    description: "Commit message"
    required: false
    default: "chore(deps): update all dependencies"

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ inputs['node-version'] }}

    - name: Run deplift
      run: npx --yes deplift@latest --major eslint=9 --major @eslint/js=9
      shell: bash

    - name: Run Tests
      id: tests
      run: npm test
      shell: bash
      continue-on-error: true

    - name: Run Build
      id: build
      run: npm run build
      shell: bash
      continue-on-error: true

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v8
      with:
        branch: ${{ inputs.branch }}
        title: ${{ inputs['pr-title'] }}
        body: |
          ${{ inputs['pr-body'] }}
          ${{ steps.tests.outcome == 'failure' && '

          ---
          ⚠️ **Tests Failed**
          Please review and fix before merging.' || '' }}
          ${{ steps.build.outcome == 'failure' && '

          ---
          ⚠️ **Build Failed**
          Please review and fix before merging.' || '' }}
        committer: ${{ inputs.committer }}
        commit-message: ${{ inputs['commit-message'] }}
        labels: ${{ inputs.labels }}${{ (steps.tests.outcome == 'failure' || steps.build.outcome == 'failure') && ', needs-fix' || '' }}
        draft: ${{ (steps.tests.outcome == 'failure' || steps.build.outcome == 'failure') && 'always-true' || 'false' }}
